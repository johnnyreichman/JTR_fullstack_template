{"ast":null,"code":"\"use strict\";\n/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\n\nvar __assign = this && this.__assign || Object.assign || function (t) {\n  for (var s, i = 1, n = arguments.length; i < n; i++) {\n    s = arguments[i];\n\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n  }\n\n  return t;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function sent() {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar url_1 = require(\"url\"); // Used for OAuth parsing of Cognito Hosted UI\n\n\nvar urlOpener_1 = require(\"./urlOpener\");\n\nvar oAuthStorage = require(\"./oauthStorage\");\n\nvar Auth_1 = require(\"../types/Auth\");\n\nvar core_1 = require(\"@aws-amplify/core\");\n\nvar SHA256 = require(\"crypto-js/sha256\");\n\nvar Base64 = require(\"crypto-js/enc-base64\");\n\nvar AMPLIFY_SYMBOL = typeof Symbol !== 'undefined' && typeof Symbol.for === 'function' ? Symbol.for('amplify_default') : '@@amplify_default';\n\nvar dispatchAuthEvent = function dispatchAuthEvent(event, data, message) {\n  core_1.Hub.dispatch('auth', {\n    event: event,\n    data: data,\n    message: message\n  }, 'Auth', AMPLIFY_SYMBOL);\n};\n\nvar logger = new core_1.ConsoleLogger('OAuth');\n\nvar OAuth =\n/** @class */\nfunction () {\n  function OAuth(_a) {\n    var config = _a.config,\n        cognitoClientId = _a.cognitoClientId,\n        _b = _a.scopes,\n        scopes = _b === void 0 ? [] : _b;\n    this._urlOpener = config.urlOpener || urlOpener_1.launchUri;\n    this._config = config;\n    this._cognitoClientId = cognitoClientId;\n    this._scopes = scopes;\n  }\n\n  OAuth.prototype.oauthSignIn = function (responseType, domain, redirectSignIn, clientId, provider, customState) {\n    if (responseType === void 0) {\n      responseType = 'code';\n    }\n\n    if (provider === void 0) {\n      provider = Auth_1.CognitoHostedUIIdentityProvider.Cognito;\n    }\n\n    var generatedState = this._generateState(32);\n\n    var state = customState ? generatedState + \"-\" + customState : generatedState;\n    oAuthStorage.setState(state);\n\n    var pkce_key = this._generateRandom(128);\n\n    oAuthStorage.setPKCE(pkce_key);\n\n    var code_challenge = this._generateChallenge(pkce_key);\n\n    var code_challenge_method = 'S256';\n    var queryString = Object.entries(__assign({\n      redirect_uri: redirectSignIn,\n      response_type: responseType,\n      client_id: clientId,\n      identity_provider: provider,\n      scopes: this._scopes,\n      state: state\n    }, responseType === 'code' ? {\n      code_challenge: code_challenge\n    } : {}, responseType === 'code' ? {\n      code_challenge_method: code_challenge_method\n    } : {})).map(function (_a) {\n      var k = _a[0],\n          v = _a[1];\n      return encodeURIComponent(k) + \"=\" + encodeURIComponent(v);\n    }).join('&');\n    var URL = \"https://\" + domain + \"/oauth2/authorize?\" + queryString;\n    logger.debug(\"Redirecting to \" + URL);\n\n    this._urlOpener(URL, redirectSignIn);\n  };\n\n  OAuth.prototype._handleCodeFlow = function (currentUrl) {\n    return __awaiter(this, void 0, void 0, function () {\n      var code, oAuthTokenEndpoint, client_id, redirect_uri, code_verifier, oAuthTokenBody, body, _a, access_token, refresh_token, id_token, error;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            code = (url_1.parse(currentUrl).query || '').split('&').map(function (pairings) {\n              return pairings.split('=');\n            }).reduce(function (accum, _a) {\n              var k = _a[0],\n                  v = _a[1];\n\n              var _b;\n\n              return __assign({}, accum, (_b = {}, _b[k] = v, _b));\n            }, {\n              code: undefined\n            }).code;\n\n            if (!code) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            oAuthTokenEndpoint = 'https://' + this._config.domain + '/oauth2/token';\n            dispatchAuthEvent('codeFlow', {}, \"Retrieving tokens from \" + oAuthTokenEndpoint);\n            client_id = Auth_1.isCognitoHostedOpts(this._config) ? this._cognitoClientId : this._config.clientID;\n            redirect_uri = Auth_1.isCognitoHostedOpts(this._config) ? this._config.redirectSignIn : this._config.redirectUri;\n            code_verifier = oAuthStorage.getPKCE();\n            oAuthTokenBody = __assign({\n              grant_type: 'authorization_code',\n              code: code,\n              client_id: client_id,\n              redirect_uri: redirect_uri\n            }, code_verifier ? {\n              code_verifier: code_verifier\n            } : {});\n            logger.debug(\"Calling token endpoint: \" + oAuthTokenEndpoint + \" with\", oAuthTokenBody);\n            body = Object.entries(oAuthTokenBody).map(function (_a) {\n              var k = _a[0],\n                  v = _a[1];\n              return encodeURIComponent(k) + \"=\" + encodeURIComponent(v);\n            }).join('&');\n            return [4\n            /*yield*/\n            , fetch(oAuthTokenEndpoint, {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/x-www-form-urlencoded'\n              },\n              body: body\n            })];\n\n          case 1:\n            return [4\n            /*yield*/\n            , _b.sent().json()];\n\n          case 2:\n            _a = _b.sent(), access_token = _a.access_token, refresh_token = _a.refresh_token, id_token = _a.id_token, error = _a.error;\n\n            if (error) {\n              throw new Error(error);\n            }\n\n            return [2\n            /*return*/\n            , {\n              accessToken: access_token,\n              refreshToken: refresh_token,\n              idToken: id_token\n            }];\n        }\n      });\n    });\n  };\n\n  OAuth.prototype._handleImplicitFlow = function (currentUrl) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, id_token, access_token;\n\n      return __generator(this, function (_b) {\n        _a = url_1.parse(currentUrl).hash.substr(1) // Remove # from returned code\n        .split('&').map(function (pairings) {\n          return pairings.split('=');\n        }).reduce(function (accum, _a) {\n          var k = _a[0],\n              v = _a[1];\n\n          var _b;\n\n          return __assign({}, accum, (_b = {}, _b[k] = v, _b));\n        }, {\n          id_token: undefined,\n          access_token: undefined\n        }), id_token = _a.id_token, access_token = _a.access_token;\n        dispatchAuthEvent('implicitFlow', {}, \"Got tokens from \" + currentUrl);\n        logger.debug(\"Retrieving implicit tokens from \" + currentUrl + \" with\");\n        return [2\n        /*return*/\n        , {\n          accessToken: access_token,\n          idToken: id_token,\n          refreshToken: null\n        }];\n      });\n    });\n  };\n\n  OAuth.prototype.handleAuthResponse = function (currentUrl) {\n    return __awaiter(this, void 0, void 0, function () {\n      var urlParams, error, error_description, state, _a, _b;\n\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            urlParams = currentUrl ? __assign({}, (url_1.parse(currentUrl).hash || '#').substr(1).split('&').map(function (entry) {\n              return entry.split('=');\n            }).reduce(function (acc, _a) {\n              var k = _a[0],\n                  v = _a[1];\n              return acc[k] = v, acc;\n            }, {}), (url_1.parse(currentUrl).query || '').split('&').map(function (entry) {\n              return entry.split('=');\n            }).reduce(function (acc, _a) {\n              var k = _a[0],\n                  v = _a[1];\n              return acc[k] = v, acc;\n            }, {})) : {};\n            error = urlParams.error, error_description = urlParams.error_description;\n\n            if (error) {\n              throw new Error(error_description);\n            }\n\n            state = this._validateState(urlParams);\n            logger.debug(\"Starting \" + this._config.responseType + \" flow with \" + currentUrl);\n            if (!(this._config.responseType === 'code')) return [3\n            /*break*/\n            , 2];\n            _a = [{}];\n            return [4\n            /*yield*/\n            , this._handleCodeFlow(currentUrl)];\n\n          case 1:\n            return [2\n            /*return*/\n            , __assign.apply(void 0, _a.concat([_c.sent(), {\n              state: state\n            }]))];\n\n          case 2:\n            _b = [{}];\n            return [4\n            /*yield*/\n            , this._handleImplicitFlow(currentUrl)];\n\n          case 3:\n            return [2\n            /*return*/\n            , __assign.apply(void 0, _b.concat([_c.sent(), {\n              state: state\n            }]))];\n        }\n      });\n    });\n  };\n\n  OAuth.prototype._validateState = function (urlParams) {\n    if (!urlParams) {\n      return;\n    }\n\n    var savedState = oAuthStorage.getState();\n    var returnedState = urlParams.state; // This is because savedState only exists if the flow was initiated by Amplify\n\n    if (savedState && savedState !== returnedState) {\n      throw new Error('Invalid state in OAuth flow');\n    }\n\n    return returnedState;\n  };\n\n  OAuth.prototype.signOut = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var oAuthLogoutEndpoint, client_id, signout_uri;\n      return __generator(this, function (_a) {\n        oAuthLogoutEndpoint = 'https://' + this._config.domain + '/logout?';\n        client_id = Auth_1.isCognitoHostedOpts(this._config) ? this._cognitoClientId : this._config.oauth.clientID;\n        signout_uri = Auth_1.isCognitoHostedOpts(this._config) ? this._config.redirectSignOut : this._config.returnTo;\n        oAuthLogoutEndpoint += Object.entries({\n          client_id: client_id,\n          logout_uri: encodeURIComponent(signout_uri)\n        }).map(function (_a) {\n          var k = _a[0],\n              v = _a[1];\n          return k + \"=\" + v;\n        }).join('&');\n        dispatchAuthEvent('oAuthSignOut', {\n          oAuth: 'signOut'\n        }, \"Signing out from \" + oAuthLogoutEndpoint);\n        logger.debug(\"Signing out from \" + oAuthLogoutEndpoint);\n        return [2\n        /*return*/\n        , this._urlOpener(oAuthLogoutEndpoint)];\n      });\n    });\n  };\n\n  OAuth.prototype._generateState = function (length) {\n    var result = '';\n    var i = length;\n    var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n\n    for (; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];\n\n    return result;\n  };\n\n  OAuth.prototype._generateChallenge = function (code) {\n    return this._base64URL(SHA256(code));\n  };\n\n  OAuth.prototype._base64URL = function (string) {\n    return string.toString(Base64).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n  };\n\n  OAuth.prototype._generateRandom = function (size) {\n    var CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\n    var buffer = new Uint8Array(size);\n\n    if (typeof window !== 'undefined' && !!window.crypto) {\n      window.crypto.getRandomValues(buffer);\n    } else {\n      for (var i = 0; i < size; i += 1) {\n        buffer[i] = Math.random() * CHARSET.length | 0;\n      }\n    }\n\n    return this._bufferToString(buffer);\n  };\n\n  OAuth.prototype._bufferToString = function (buffer) {\n    var CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    var state = [];\n\n    for (var i = 0; i < buffer.byteLength; i += 1) {\n      var index = buffer[i] % CHARSET.length;\n      state.push(CHARSET[index]);\n    }\n\n    return state.join('');\n  };\n\n  return OAuth;\n}();\n\nexports.default = OAuth;","map":{"version":3,"sources":["../../src/OAuth/OAuth.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n/*\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\nvar __assign = (this && this.__assign) || Object.assign || function(t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n        s = arguments[i];\n        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n            t[p] = s[p];\n    }\n    return t;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar url_1 = require(\"url\"); // Used for OAuth parsing of Cognito Hosted UI\nvar urlOpener_1 = require(\"./urlOpener\");\nvar oAuthStorage = require(\"./oauthStorage\");\nvar Auth_1 = require(\"../types/Auth\");\nvar core_1 = require(\"@aws-amplify/core\");\nvar SHA256 = require(\"crypto-js/sha256\");\nvar Base64 = require(\"crypto-js/enc-base64\");\nvar AMPLIFY_SYMBOL = ((typeof Symbol !== 'undefined' && typeof Symbol.for === 'function') ?\n    Symbol.for('amplify_default') : '@@amplify_default');\nvar dispatchAuthEvent = function (event, data, message) {\n    core_1.Hub.dispatch('auth', { event: event, data: data, message: message }, 'Auth', AMPLIFY_SYMBOL);\n};\nvar logger = new core_1.ConsoleLogger('OAuth');\nvar OAuth = /** @class */ (function () {\n    function OAuth(_a) {\n        var config = _a.config, cognitoClientId = _a.cognitoClientId, _b = _a.scopes, scopes = _b === void 0 ? [] : _b;\n        this._urlOpener = config.urlOpener || urlOpener_1.launchUri;\n        this._config = config;\n        this._cognitoClientId = cognitoClientId;\n        this._scopes = scopes;\n    }\n    OAuth.prototype.oauthSignIn = function (responseType, domain, redirectSignIn, clientId, provider, customState) {\n        if (responseType === void 0) { responseType = 'code'; }\n        if (provider === void 0) { provider = Auth_1.CognitoHostedUIIdentityProvider.Cognito; }\n        var generatedState = this._generateState(32);\n        var state = customState ? generatedState + \"-\" + customState : generatedState;\n        oAuthStorage.setState(state);\n        var pkce_key = this._generateRandom(128);\n        oAuthStorage.setPKCE(pkce_key);\n        var code_challenge = this._generateChallenge(pkce_key);\n        var code_challenge_method = 'S256';\n        var queryString = Object.entries(__assign({ redirect_uri: redirectSignIn, response_type: responseType, client_id: clientId, identity_provider: provider, scopes: this._scopes, state: state }, (responseType === 'code' ? { code_challenge: code_challenge } : {}), (responseType === 'code' ? { code_challenge_method: code_challenge_method } : {}))).map(function (_a) {\n            var k = _a[0], v = _a[1];\n            return encodeURIComponent(k) + \"=\" + encodeURIComponent(v);\n        }).join('&');\n        var URL = \"https://\" + domain + \"/oauth2/authorize?\" + queryString;\n        logger.debug(\"Redirecting to \" + URL);\n        this._urlOpener(URL, redirectSignIn);\n    };\n    OAuth.prototype._handleCodeFlow = function (currentUrl) {\n        return __awaiter(this, void 0, void 0, function () {\n            var code, oAuthTokenEndpoint, client_id, redirect_uri, code_verifier, oAuthTokenBody, body, _a, access_token, refresh_token, id_token, error;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        code = (url_1.parse(currentUrl).query || '')\n                            .split('&')\n                            .map(function (pairings) { return pairings.split('='); })\n                            .reduce(function (accum, _a) {\n                            var k = _a[0], v = _a[1];\n                            var _b;\n                            return (__assign({}, accum, (_b = {}, _b[k] = v, _b)));\n                        }, { code: undefined }).code;\n                        if (!code) {\n                            return [2 /*return*/];\n                        }\n                        oAuthTokenEndpoint = 'https://' + this._config.domain + '/oauth2/token';\n                        dispatchAuthEvent('codeFlow', {}, \"Retrieving tokens from \" + oAuthTokenEndpoint);\n                        client_id = Auth_1.isCognitoHostedOpts(this._config)\n                            ? this._cognitoClientId\n                            : this._config.clientID;\n                        redirect_uri = Auth_1.isCognitoHostedOpts(this._config)\n                            ? this._config.redirectSignIn\n                            : this._config.redirectUri;\n                        code_verifier = oAuthStorage.getPKCE();\n                        oAuthTokenBody = __assign({ grant_type: 'authorization_code', code: code,\n                            client_id: client_id,\n                            redirect_uri: redirect_uri }, (code_verifier ? { code_verifier: code_verifier } : {}));\n                        logger.debug(\"Calling token endpoint: \" + oAuthTokenEndpoint + \" with\", oAuthTokenBody);\n                        body = Object.entries(oAuthTokenBody)\n                            .map(function (_a) {\n                            var k = _a[0], v = _a[1];\n                            return encodeURIComponent(k) + \"=\" + encodeURIComponent(v);\n                        })\n                            .join('&');\n                        return [4 /*yield*/, fetch(oAuthTokenEndpoint, {\n                                method: 'POST',\n                                headers: {\n                                    'Content-Type': 'application/x-www-form-urlencoded'\n                                },\n                                body: body\n                            })];\n                    case 1: return [4 /*yield*/, (_b.sent()).json()];\n                    case 2:\n                        _a = _b.sent(), access_token = _a.access_token, refresh_token = _a.refresh_token, id_token = _a.id_token, error = _a.error;\n                        if (error) {\n                            throw new Error(error);\n                        }\n                        return [2 /*return*/, {\n                                accessToken: access_token,\n                                refreshToken: refresh_token,\n                                idToken: id_token\n                            }];\n                }\n            });\n        });\n    };\n    OAuth.prototype._handleImplicitFlow = function (currentUrl) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _a, id_token, access_token;\n            return __generator(this, function (_b) {\n                _a = url_1.parse(currentUrl).hash\n                    .substr(1) // Remove # from returned code\n                    .split('&')\n                    .map(function (pairings) { return pairings.split('='); })\n                    .reduce(function (accum, _a) {\n                    var k = _a[0], v = _a[1];\n                    var _b;\n                    return (__assign({}, accum, (_b = {}, _b[k] = v, _b)));\n                }, {\n                    id_token: undefined, access_token: undefined\n                }), id_token = _a.id_token, access_token = _a.access_token;\n                dispatchAuthEvent('implicitFlow', {}, \"Got tokens from \" + currentUrl);\n                logger.debug(\"Retrieving implicit tokens from \" + currentUrl + \" with\");\n                return [2 /*return*/, {\n                        accessToken: access_token,\n                        idToken: id_token,\n                        refreshToken: null\n                    }];\n            });\n        });\n    };\n    OAuth.prototype.handleAuthResponse = function (currentUrl) {\n        return __awaiter(this, void 0, void 0, function () {\n            var urlParams, error, error_description, state, _a, _b;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        urlParams = currentUrl ? __assign({}, (url_1.parse(currentUrl).hash || '#').substr(1)\n                            .split('&')\n                            .map(function (entry) { return entry.split('='); })\n                            .reduce(function (acc, _a) {\n                            var k = _a[0], v = _a[1];\n                            return (acc[k] = v, acc);\n                        }, {}), (url_1.parse(currentUrl).query || '')\n                            .split('&')\n                            .map(function (entry) { return entry.split('='); })\n                            .reduce(function (acc, _a) {\n                            var k = _a[0], v = _a[1];\n                            return (acc[k] = v, acc);\n                        }, {})) : {};\n                        error = urlParams.error, error_description = urlParams.error_description;\n                        if (error) {\n                            throw new Error(error_description);\n                        }\n                        state = this._validateState(urlParams);\n                        logger.debug(\"Starting \" + this._config.responseType + \" flow with \" + currentUrl);\n                        if (!(this._config.responseType === 'code')) return [3 /*break*/, 2];\n                        _a = [{}];\n                        return [4 /*yield*/, this._handleCodeFlow(currentUrl)];\n                    case 1: return [2 /*return*/, __assign.apply(void 0, _a.concat([_c.sent(), { state: state }]))];\n                    case 2:\n                        _b = [{}];\n                        return [4 /*yield*/, this._handleImplicitFlow(currentUrl)];\n                    case 3: return [2 /*return*/, __assign.apply(void 0, _b.concat([_c.sent(), { state: state }]))];\n                }\n            });\n        });\n    };\n    OAuth.prototype._validateState = function (urlParams) {\n        if (!urlParams) {\n            return;\n        }\n        var savedState = oAuthStorage.getState();\n        var returnedState = urlParams.state;\n        // This is because savedState only exists if the flow was initiated by Amplify\n        if (savedState && savedState !== returnedState) {\n            throw new Error('Invalid state in OAuth flow');\n        }\n        return returnedState;\n    };\n    OAuth.prototype.signOut = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var oAuthLogoutEndpoint, client_id, signout_uri;\n            return __generator(this, function (_a) {\n                oAuthLogoutEndpoint = 'https://' + this._config.domain + '/logout?';\n                client_id = Auth_1.isCognitoHostedOpts(this._config)\n                    ? this._cognitoClientId\n                    : this._config.oauth.clientID;\n                signout_uri = Auth_1.isCognitoHostedOpts(this._config)\n                    ? this._config.redirectSignOut\n                    : this._config.returnTo;\n                oAuthLogoutEndpoint += Object.entries({\n                    client_id: client_id,\n                    logout_uri: encodeURIComponent(signout_uri)\n                }).map(function (_a) {\n                    var k = _a[0], v = _a[1];\n                    return k + \"=\" + v;\n                }).join('&');\n                dispatchAuthEvent('oAuthSignOut', { oAuth: 'signOut' }, \"Signing out from \" + oAuthLogoutEndpoint);\n                logger.debug(\"Signing out from \" + oAuthLogoutEndpoint);\n                return [2 /*return*/, this._urlOpener(oAuthLogoutEndpoint)];\n            });\n        });\n    };\n    OAuth.prototype._generateState = function (length) {\n        var result = '';\n        var i = length;\n        var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n        for (; i > 0; --i)\n            result += chars[Math.round(Math.random() * (chars.length - 1))];\n        return result;\n    };\n    OAuth.prototype._generateChallenge = function (code) {\n        return this._base64URL(SHA256(code));\n    };\n    OAuth.prototype._base64URL = function (string) {\n        return string.toString(Base64).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n    };\n    OAuth.prototype._generateRandom = function (size) {\n        var CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\n        var buffer = new Uint8Array(size);\n        if (typeof window !== 'undefined' && !!(window.crypto)) {\n            window.crypto.getRandomValues(buffer);\n        }\n        else {\n            for (var i = 0; i < size; i += 1) {\n                buffer[i] = (Math.random() * CHARSET.length) | 0;\n            }\n        }\n        return this._bufferToString(buffer);\n    };\n    OAuth.prototype._bufferToString = function (buffer) {\n        var CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n        var state = [];\n        for (var i = 0; i < buffer.byteLength; i += 1) {\n            var index = buffer[i] % CHARSET.length;\n            state.push(CHARSET[index]);\n        }\n        return state.join('');\n    };\n    return OAuth;\n}());\nexports.default = OAuth;\n//# sourceMappingURL=OAuth.js.map"]},"metadata":{},"sourceType":"script"}